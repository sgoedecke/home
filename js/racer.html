<html>
	<head>
	<style type="text/css">
		#console, h1 {
			font-family: courier;
		}
	</style>
	</head>

	<body>
	<img hidden id="spaceship" width="10" height="10" src="spaceship.jpg">
	<h1>Chute Racer</h1>
		<div>
			<canvas id="canvas" width="400" height="400"></canvas>
		</div>
		<div>
			<span id="console"> </span>	
		</div>
		
		<script>
			// variables
			var canvas = document.getElementById("canvas");
			var ctx = canvas.getContext("2d");
			var console = document.getElementById("console");

			document.onkeydown = handleKeys;
			document.onkeyup = clearKeys;
			var current_input;

			var LANE_WIDTH = 100; //width of the chute the player travels through
			var INITIAL_LANE_WIDTH = 100; //this is the one we don't mess with

			var PLAYER_SPEED = 1; // how fast the player travels per keystroke
			var GAME_SPEED = 5; // ms paused between loops
			var PLAYER_WIDTH = 10;

			var BACKGROUND_COLOUR = "#000000" // boring awful colour scheme
			var SCORE_COLOUR = "#ffffff"
			var CHUTE_COLOUR = "#ffffff"
			var PLAYER_COLOUR = "#E82B0C"
			var PAUSE_MENU_COLOUR = "#ffffff"
			var PAUSE_TEXT_COLOUR = "#000000" 

		/*	var BACKGROUND_COLOUR = "#04140A" // bright awful colour scheme
			var SCORE_COLOUR = "#34FF80"
			var CHUTE_COLOUR = "#0CA4E8"
			var PLAYER_COLOUR = "#FF6328"
			var PAUSE_MENU_COLOUR = "#ffffff"
			var PAUSE_TEXT_COLOUR = "#000000" */

			var player_position;
			var obstacles = []; //array of obstacles on the map
			var score = 0;

			var direction_bias = 5;
			var isPaused = false;

			// functions which handle game events
			function generateObstacles() {
				obstacles = []; // clear old obstacles
				var starting_point = (canvas.width - LANE_WIDTH) / 2

				obstacles.push(starting_point);
				
				for (i=0; i<canvas.height; i=i+1) { //generate an obstacle every pixel
					generateNewObstacle();
					}
				return obstacles
				}

			function getActiveObstacle() {
				active_obstacle = obstacles.shift(); // pluck off the first item in the obstacles array
				return active_obstacle
			}

			function generateNewObstacle() {
				var candidate_obstacle = 0;
				var last_obstacle = obstacles[obstacles.length - 1];
				var randint;

				// set likelihoods
				if (last_obstacle < 50) {
					direction_bias = 7;
				} else if (last_obstacle > 250) {
					direction_bias = 3;
				} else {
					//direction_bias = 5; // no bias
				}

				while ((candidate_obstacle < 1) || (candidate_obstacle > canvas.width-LANE_WIDTH-10)){
					// while the candidate object is unacceptable
					randint = Math.floor((Math.random()*10)+1); // generate random integer between 1 and 10
					if (randint < direction_bias) {
							candidate_obstacle = last_obstacle + 1; //go right
						} else if (randint == direction_bias) {
							candidate_obstacle = last_obstacle; // go straight up
						} else {
							candidate_obstacle = last_obstacle - 1; // go left
						}
				}

				obstacles.push(candidate_obstacle);
			}

			function hasCollided(active_obstacle) {
				//simple check
				if (player_position == active_obstacle || player_position + PLAYER_WIDTH == active_obstacle + LANE_WIDTH) {
					return true;
				} else if (player_position < active_obstacle || player_position + PLAYER_WIDTH > active_obstacle + LANE_WIDTH) {
					return true;
				} else {
					return false;
				}
			}

			function goLeft() {
				player_position = player_position - PLAYER_SPEED;
			}

			function goRight() {
				player_position = player_position + PLAYER_SPEED;
			}

			function handleScoreEffects() {

				score_penalty = Math.floor(score/100);
				LANE_WIDTH = INITIAL_LANE_WIDTH-score_penalty

			}

			// functions which handle setup and teardown
			function newGame() {
				obstacles = generateObstacles();
				player_position = 200;
				current_input = "none";
				direction_bias = 5; //no bias
				PLAYER_WIDTH = 10;
				LANE_WIDTH = 100;
				score = 0;
			}

			function endGame() {
				msgDeath();
				switchPaused();
				newGame();
			}


			// display functions

			function msgDeath() {
				var displayed_score = Math.floor(score/50);
				console.innerHTML = "<h3>you died! final score: " + String(displayed_score) + "</h3>";
			}
			function msgClear() {
				console.innerHTML = "";
			}
			function msgPrint(msg) {
				console.innerHTML = "<h3>" + msg + "</h3>";
			}

			function drawIntro() {
				// clear canvas
				ctx.clearRect(0,0,canvas.width, canvas.height);

				// draw background
				ctx.fillStyle = BACKGROUND_COLOUR; //black
				ctx.fillRect(0,0,canvas.width, canvas.height)	
			}

			function drawGame() {
				// clear canvas
				ctx.clearRect(0,0,canvas.width, canvas.height);

				// draw background
				ctx.fillStyle = BACKGROUND_COLOUR; //black
				ctx.fillRect(0,0,canvas.width, canvas.height)

				// draw score
				ctx.fillStyle = SCORE_COLOUR; //white
				ctx.font = "20px Courier New";
				var displayed_score = Math.floor(score/50);
				ctx.fillText(String(displayed_score), canvas.width-50, 30);

				// draw obstacles
				ctx.fillStyle = CHUTE_COLOUR; //white
				var c;
				var obstacle
				var i=canvas.height;
				for (c in obstacles) {
					obstacle = obstacles[c];

				//	code for drawing obstacles
				//	ctx.fillRect(obstacle, i,1,1);
				//	ctx.fillRect(obstacle + LANE_WIDTH, i,1,1); //draw second obstacle

					//draw space between obstacles
					ctx.fillRect(obstacle+1,i,LANE_WIDTH-1,1);

					i = i - 1;
				}

				//draw player
				ctx.fillStyle = PLAYER_COLOUR; //black
				//ctx.fillRect(player_position,canvas.height-PLAYER_WIDTH,PLAYER_WIDTH,10);
				var spaceship = document.getElementById("spaceship");
				ctx.drawImage(spaceship, player_position,canvas.height-PLAYER_WIDTH);

			}

			function drawPauseMenu() {
				var menu_width = 350;
				var menu_height = 50;
				var width_margin = (canvas.width-menu_width)/2;
				var height_margin = (canvas.height-menu_height)/2;
				ctx.fillStyle = PAUSE_MENU_COLOUR;
				ctx.fillRect(width_margin, height_margin,menu_width, menu_height);
				ctx.fillStyle = PAUSE_TEXT_COLOUR; //black
				ctx.font = "20px Courier New";
				ctx.fillText("press SPACEBAR to continue", width_margin + 10, height_margin + 30)
			}

			function handleKeys(key) {
				switch (key.keyCode) {
					case 37:
						//left
						current_input = "left";
						break;
					case 38:
						//up
						current_input = "up";
						break;
					case 39:
						//right
						current_input = "right";
						break;
					case 32:
						//space bar
						switchPaused();
						break;

				}

			}
			function clearKeys(){
				current_input = "none";
			}

			function switchPaused(){
				if (!isPaused){
					isPaused = true;
					//draw paused stuff
					drawPauseMenu();
				} else {
					isPaused = false;

					//clear paused stuff
					msgClear();
					drawGame();
				}
			}

			function mainLoop() {
				active_obstacle = getActiveObstacle();
				// increment score
				score++;

				// handle score effects
				handleScoreEffects();

				// check if the player hit something
				if (hasCollided(active_obstacle)) {
					endGame();
					return; // don't do this other stuff below
				}
				// handle keystrokes
				switch (current_input) {
					case "left":
						goLeft();
						break;
					case "right":
						goRight();
						break;
					}

				// generate new obstacles
				generateNewObstacle();
				// draw game
				drawGame();

 
			}

			function runGame(){
				if (!isPaused) {
					mainLoop();
				}
			}
		
		// execute these commands
		drawIntro();
		switchPaused();
		newGame();
		setInterval(runGame, GAME_SPEED); 
	//	mainLoop();


		</script>

	</body>

</html>